<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NTS E-shop - Produkty</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Základní styl pro tělo */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Styly pro modální okno */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-container {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 90%;
            width: 600px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            z-index: 100;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .image-placeholder {
            width: 100%;
            height: 160px;
            background-color: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            border-radius: 0.5rem 0.5rem 0 0;
            margin-bottom: 0;
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans antialiased">

    <div class="container mx-auto max-w-6xl p-4 md:p-8">

        <h1 class="text-4xl font-extrabold text-gray-900 mb-6">NTS E-shop</h1>
        <p class="text-lg text-gray-600 mb-8">Zde naleznete aktuální nabídku produktů. Vyberte si prosím kategorii. Vše za bezkonkurenční ceny, výhodné nabídky a sposuta levných produktů! Rychlé doručení na spoustu produktů při osobním odběru!</p>
        <button style="background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-bottom: 10px;" onclick="window.location.href='https://nts-windows-tools.github.io/manualy-k-prodanym/'">Návody, manuály a informace k prodaným produktům bazar</button>
        <button style="background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;" onclick="window.location.href='https://nts-windows-tools.github.io/soutez-o-podlozku-main/'">Aktuální probíhající soutěže</button><br><br>
        <button style="background-color: #0056b3; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;" onclick="window.location.href='https://nts-windows-tools.github.io/jfdhusghsgfjgh14dg2h54f521h5124/'">Vaše objednávky</button><br><br>
        
        <div id="initial-category-select" class="flex flex-col md:flex-row gap-6 mb-8 h-80">
            <button data-category="Nove" id="btn-select-nove" class="flex-1 flex flex-col items-center justify-center text-3xl font-extrabold text-white p-12 rounded-2xl shadow-2xl transition duration-300 hover:scale-[1.02] bg-green-500 hover:bg-green-600">
                Nové produkty
            </button>
            <button data-category="Bazar" id="btn-select-bazar" class="flex-1 flex flex-col items-center justify-center text-3xl font-extrabold text-white p-12 rounded-2xl shadow-2xl transition duration-300 hover:scale-[1.02] bg-orange-500 hover:bg-orange-600">
                Bazárek
            </button>
        </div>

        <p id="loading-message" class="text-center text-xl text-gray-500 p-8">Moment prosím, stále stahujeme nová data z databáze. Zabere to jen pár sekund...</p>
        
        <div id="product-list-container" class="hidden">
            <h2 id="current-category-title" class="text-3xl font-bold text-gray-800 mb-6"></h2>
            <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
        </div>
    </div>

    <div id="product-detail-modal" class="modal modal-overlay hidden">
        <div class="modal-container">
            <div class="overflow-y-auto pr-4 flex-grow">
                <h3 id="detail-product-name" class="text-3xl font-bold text-gray-800 mb-4">Název produktu</h3>
                
                <div id="detail-image-container" class="mb-4">
                    <p id="detail-photo-link" class="text-gray-700 text-sm font-medium mb-4">NTS Foto: Není k dispozici</p>
                    <div class="image-placeholder">Není k dispozici náhled obrázku</div>
                </div>

                <p class="text-sm font-semibold text-indigo-600 mb-2">Stav:</p>
                <p id="detail-stav" class="text-gray-700 mb-4"></p>

                <p class="text-sm font-semibold text-indigo-600 mb-2">Popis:</p>
                <p id="detail-popis" class="text-gray-700 mb-4 whitespace-pre-line"></p>

                <p class="text-sm font-semibold text-indigo-600 mb-2">Ceny:</p>
                <p id="detail-cena" class="text-gray-900 font-bold text-lg mb-4 whitespace-pre-line border-l-4 border-indigo-500 pl-3 bg-indigo-50 py-2"></p>

                <p class="text-sm font-semibold text-indigo-600 mb-2">Dostupnost:</p>
                <p id="detail-dostupnost" class="text-gray-700 mb-4"></p>

                <p class="text-sm font-semibold text-indigo-600 mb-2">Kusů skladem:</p>
                <p id="detail-kusy" class="text-gray-700 text-xl font-bold mb-6"></p>
            </div>

            <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 mt-4 items-center flex-wrap">
                <button id="btn-close-detail" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition duration-200">
                    Zavřít
                </button>
                
                <button id="btn-offer-price" class="hidden bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 transition duration-200">
                    Nabídnout cenu
                </button>

                <button id="btn-buy-now" class="bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition duration-200 flex items-center gap-2 text-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path d="M2.25 2.25a.75.75 0 0 0 0 1.5h1.386c.17 0 .318.114.362.278l2.558 9.592a3.75 3.75 0 0 0 7.454.225-.75.75 0 0 0-1.489-.374 2.25 2.25 0 0 1-4.48.119l-2.062-7.747h14.426a.75.75 0 0 0 0-1.5H2.25Z" />
                        <path d="M12.75 19.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5ZM17.25 19.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" />
                    </svg>
                    Koupit nyní
                </button>
            </div>
        </div>
    </div>

    <div id="offer-price-modal" class="modal modal-overlay hidden">
        <div class="modal-container">
            <h3 id="offer-modal-title" class="text-xl font-bold text-gray-800 mb-4">Nabídněte nám cenu k produktu: ...</h3>
            <div class="overflow-y-auto mb-4">
                <p class="text-sm text-gray-700 mb-4">
                    Zadejte cenu, za kterou jste ochotni tento produkt koupit. V eshopu se na Vaši nabídku mrkneme a zhodnotíme ji. Vaši nabídku můžeme zamítnout a produkt ponechat beze změny (např. při návrhu absurdních nízkých a nereálných cen) nebo také můžeme vystavit protinabídku, o které můžeme dále jednat, zda produkt koupíte za vyšší cenu. Také se může stát, že Vaši nabídku ceny přijmeme.
                </p>
                <p class="text-sm text-gray-700 font-bold mb-4">
                    DŮLEŽITÉ: Po zadání nabídky ceny si sledujte informace v popisu produktu, zde naleznete výsledky Vaší žádosti. Pokud nabídku ceny přijmeme, již to nejde vzít zpět a ihned po našem přijetí vzniká uzavřený nákup, který budete muset uhradit. Proto prosím nenabízejte nižší ceny u produktů, které nechcete, nebo je nejste schopni zaplatit. Děkujeme.
                </p>
            </div>
            
            <form id="offer-price-form">
                <label class="block text-gray-700 font-bold mb-2">Zde nabídněte svou cenu:</label>
                <input type="text" pattern="[0-9]*" id="offer-price-input" class="w-full border border-gray-300 p-3 rounded-lg mb-4" placeholder="Zapište pouze číslo bez znaku Kč, např. 500" required>
                
                <div class="flex justify-end gap-3">
                    <button type="button" id="btn-cancel-offer" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Zrušit</button>
                    <button type="submit" class="bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600">Odeslat</button>
                </div>
            </form>
        </div>
    </div>

    <div id="reservation-modal" class="modal modal-overlay hidden">
        <div class="modal-container">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Zadat počet kusů</h3>
            <p id="quantity-prompt" class="text-gray-700 mb-4">Rozhodněte, kolik kusů chcete zakoupit - zapište pouze číslo níže:</p>
            
            <form id="quantity-form" class="space-y-4">
                <div>
                    <input type="text" pattern="[0-9]*" id="purchase-quantity-input" class="mt-1 block w-full px-4 py-3 text-2xl border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Zadejte počet kusů" value="1" required>
                </div>
                
                <p id="quantity-error-message" class="text-red-500 font-semibold hidden"></p>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="btn-cancel-quantity" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition duration-200">
                        Zpět
                    </button>
                    <button type="submit" id="btn-next-step" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-200">
                        Další
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="checkout-options-modal" class="modal modal-overlay hidden">
        <div class="modal-container">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Pojďme vyřídit pár věcí:</h3>
            
            <form id="checkout-form" class="space-y-6 overflow-y-auto pr-2">
                
                <div>
                    <h4 class="text-lg font-bold text-gray-700 mb-2">Jak chcete zaplatit?</h4>
                    <div class="space-y-2">
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="paymentMethod" value="Hotově předem ihned před objednání" checked class="h-5 w-5 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                            <span class="ml-3 text-gray-700">Zaplatit hotově předem ihned po objednávce</span>
                        </label>
                        
                        <label id="option-cod" class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 hidden">
                            <input type="radio" name="paymentMethod" value="Dobírka po převzetí objednávky + 39 Kč" class="h-5 w-5 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                            <span class="ml-3 text-gray-700">Zaplatit hotově při převzetí zboží dobírkou (+ 39 Kč)</span>
                        </label>
                    </div>
                </div>

                <div id="discount-section">
                    <h4 class="text-lg font-bold text-gray-700 mb-2">Máte slevový kód?</h4>
                    <div class="flex items-center mb-2">
                        <input type="checkbox" id="has-discount-code" class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="has-discount-code" class="ml-3 text-gray-700">Mám slevový kód</label>
                    </div>
                    
                    <div id="discount-input-container" class="hidden mt-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Zadejte slevový kód:</label>
                        <input type="text" id="discount-code-input" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <p id="no-discount-text" class="text-sm text-gray-500 mt-1 italic">Pokračovat bez slevového kódu</p>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t">
                    <button type="button" id="btn-back-to-quantity" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">
                        Zpět
                    </button>
                    <button type="submit" class="bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 text-lg">
                        Objednat
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="toast-container" class="fixed top-4 right-4 z-[500] space-y-2"></div>

    <div id="auth-loading-modal" class="hidden fixed top-0 left-0 right-0 bottom-0 bg-gray-900 bg-opacity-75 text-white p-8 flex flex-col items-center justify-center z-[1000] text-xl">
        <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="auth-loading-text" class="mt-4 font-bold">Vyčkejte, autorizujeme objednávku se serverem...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDWuTL_dbpAaLc6GEaIBwyQMCemYrrT1DM",
            authDomain: "nts-eshop.firebaseapp.com",
            projectId: "nts-eshop",
            databaseURL: "https://nts-eshop-default-rtdb.europe-west1.firebasedatabase.app",
            storageBucket: "nts-eshop.firebasestorage.app",
            messagingSenderId: "882610702624",
            appId: "1:882610702624:web:d692d9421d493119ebaf45",
            measurementId: "G-C2G6CMEBJ5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const productsRef = ref(db, 'products');

        let allProducts = {};
        let currentFilter = null;
        let currentReservationKey = null;
        let pendingQuantity = 0; // Uložení množství před druhým krokem

        // DOM Elementy
        const productList = document.getElementById('product-list');
        const loadingMessage = document.getElementById('loading-message');
        const quantityModal = document.getElementById('reservation-modal');
        const quantityForm = document.getElementById('quantity-form');
        const purchaseQuantityInput = document.getElementById('purchase-quantity-input');
        const quantityErrorMessage = document.getElementById('quantity-error-message');
        
        // Checkout Modal Elementy
        const checkoutModal = document.getElementById('checkout-options-modal');
        const checkoutForm = document.getElementById('checkout-form');
        const discountSection = document.getElementById('discount-section');
        const optionCOD = document.getElementById('option-cod');
        const hasDiscountCheckbox = document.getElementById('has-discount-code');
        const discountInputContainer = document.getElementById('discount-input-container');
        const noDiscountText = document.getElementById('no-discount-text');
        
        // Offer Price Elements
        const btnOfferPrice = document.getElementById('btn-offer-price');
        const offerPriceModal = document.getElementById('offer-price-modal');
        const offerModalTitle = document.getElementById('offer-modal-title');
        const offerPriceForm = document.getElementById('offer-price-form');

        // === Utility ===
        function showToast(text, isError = false) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.textContent = text;
            toast.className = `p-3 rounded-lg shadow-xl font-bold transition duration-300 transform translate-y-0 ${isError ? 'bg-red-500' : 'bg-green-500'} text-white opacity-100`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showLoadingScreen(text) {
            document.getElementById('auth-loading-text').textContent = text;
            document.getElementById('auth-loading-modal').classList.remove('hidden');
        }

        function hideLoadingScreen() {
            document.getElementById('auth-loading-modal').classList.add('hidden');
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // === Renderování ===

        function renderProductCard(key, product) {
            const kusy = parseInt(product.Kusy || 0, 10);
            const isAvailable = kusy > 0;
            const photoUrl = product.Foto && product.Foto.split(',')[0].trim();
            const imageHtml = photoUrl
                ? `<div class="image-placeholder h-40">Foto dostupné po otevření produktu</div>`
                : `<div class="image-placeholder h-40">Není k dispozici náhled obrázku</div>`;

            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300';
            card.dataset.key = key;

            card.innerHTML = `
                ${imageHtml}
                <div class="p-4 flex flex-col justify-between h-auto">
                    <div>
                        <span class="text-xs font-medium text-gray-500">${product.Typ === 'Nove' ? 'NOVÁ PRODEJKA' : 'BAZAR'}</span>
                        <h2 class="text-xl font-bold text-gray-800 mt-0 mb-2">${product.PRODUCT}</h2>
                        <p class="text-sm text-gray-600 mb-4 h-12 overflow-hidden">${product.Popis.substring(0, 80)}...</p>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-base font-bold ${isAvailable ? 'text-green-600' : 'text-red-500'}">
                            ${isAvailable ? `Skladem: ${kusy} ks` : 'Není skladem'}
                        </span>
                        <button data-key="${key}" ${!isAvailable ? 'disabled' : ''} class="btn-show-detail bg-indigo-600 text-white font-bold py-1.5 px-3 rounded-lg hover:bg-indigo-700 text-sm transition duration-150 ${!isAvailable ? 'opacity-50 cursor-not-allowed' : ''}">
                            Více info
                        </button>
                    </div>
                </div>
            `;
            
            const detailButton = card.querySelector('.btn-show-detail');
            if (detailButton) detailButton.onclick = (e) => {
                e.stopPropagation();
                if (kusy > 0) showProductDetail(key);
            };
            return card;
        }

        function renderProductList(products, filter) {
            productList.innerHTML = '';
            let found = 0;
            const categoryName = filter === 'Nove' ? 'Nové produkty' : 'Bazárek';
            document.getElementById('current-category-title').textContent = categoryName;

            if (!products || Object.keys(products).length === 0) {
                productList.innerHTML = `<p class="col-span-full text-center text-gray-500 p-8">Žádné produkty...</p>`;
                return;
            }

            Object.entries(products).forEach(([key, product]) => {
                if (product.Typ === filter) {
                    productList.appendChild(renderProductCard(key, product));
                    found++;
                }
            });

            if (found === 0) {
                productList.innerHTML = `<p class="col-span-full text-center text-gray-500 p-8">V kategorii "${categoryName}" nejsou žádné dostupné produkty.</p>`;
            }
        }

        function selectCategory(category) {
            currentFilter = category;
            document.getElementById('initial-category-select').classList.add('hidden');
            loadingMessage.classList.add('hidden');
            document.getElementById('product-list-container').classList.remove('hidden');
            renderProductList(allProducts, currentFilter);
        }

        // === Detail produktu ===

        function showProductDetail(key) {
            const product = allProducts[key];
            if (!product) return;

            currentReservationKey = key;

            document.getElementById('detail-product-name').textContent = product.PRODUCT;
            document.getElementById('detail-stav').textContent = product.Stav || 'N/A';
            document.getElementById('detail-popis').textContent = product.Popis || 'Není k dispozici.';
            document.getElementById('detail-cena').textContent = product.CenaText || 'Cena v popisku produktu!';
            document.getElementById('detail-dostupnost').textContent = product.Dostupnost || 'N/A';
            document.getElementById('detail-kusy').textContent = `${product.Kusy} ks`;
            
            // Foto logic
            const photoLinkElement = document.getElementById('detail-photo-link');
            const photos = product.Foto ? product.Foto.split(',').map(f => f.trim()).filter(f => f) : [];
            if (photos.length > 0) {
                photoLinkElement.innerHTML = `NTS Foto: <a href="${photos[0]}" target="_blank" class="text-blue-500 hover:text-blue-700 underline font-normal break-all">${photos[0]}</a>`;
                document.querySelector('#detail-image-container .image-placeholder').textContent = "Obrázky k dispozici na odkazu výše";
            } else {
                photoLinkElement.innerHTML = `NTS Foto: Není k dispozici`;
                document.querySelector('#detail-image-container .image-placeholder').textContent = "Není k dispozici náhled obrázku";
            }

            // Koupit tlačítko logic
            const btnBuyNow = document.getElementById('btn-buy-now');
            if (product.Kusy > 0) {
                btnBuyNow.classList.remove('bg-gray-400', 'cursor-not-allowed', 'opacity-50');
                btnBuyNow.classList.add('bg-green-500', 'hover:bg-green-600');
                btnBuyNow.disabled = false;
            } else {
                btnBuyNow.classList.remove('bg-green-500', 'hover:bg-green-600');
                btnBuyNow.classList.add('bg-gray-400', 'cursor-not-allowed', 'opacity-50');
                btnBuyNow.disabled = true;
            }

            // Nabídka ceny - Tlačítko Logic
            const allowOffer = product.Nastaveni_NabidkaCeny && parseInt(product.Nastaveni_NabidkaCeny, 10) === 1;
            
            if (allowOffer) {
                btnOfferPrice.classList.remove('hidden');
                
                // Kontrola, zda uživatel již nabídku podal (pro zjednodušení v tomto demu kontrolujeme jen DB stav, 
                // v reálu by se kontrolovalo ID session nebo local storage, ale zadání říká "blokovat tlačítko tím, že v db je číslo")
                // Zde se spoléháme na logiku: Pokud je v DB u produktu hodnota, tlacitko zasedne pro vsechny (v tomto jednoduchém demu) 
                // nebo specificky (pokud bychom měli user auth). Pro tento účel: pokud 'User_Nabidka_Cena' existuje nebo 'User_Nabidka_Stav' == ACCEPTED
                
                const offerExists = product.User_Nabidka_Cena != null;
                const offerAccepted = product.User_Nabidka_Stav === 'ACCEPTED';

                if (offerExists || offerAccepted) {
                    // Zašednout tlačítko
                    btnOfferPrice.disabled = true;
                    btnOfferPrice.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                    btnOfferPrice.classList.add('bg-gray-400', 'cursor-not-allowed');
                    btnOfferPrice.title = "Nabídka již byla odeslána";
                } else {
                    // Povolit tlačítko
                    btnOfferPrice.disabled = false;
                    btnOfferPrice.classList.add('bg-orange-500', 'hover:bg-orange-600');
                    btnOfferPrice.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    btnOfferPrice.title = "";
                }
            } else {
                btnOfferPrice.classList.add('hidden');
            }

            showModal('product-detail-modal');
        }

        // === Logika Nabídky Ceny ===

        btnOfferPrice.onclick = () => {
             const product = allProducts[currentReservationKey];
             offerModalTitle.textContent = `Nabídněte nám cenu k produktu: ${product.PRODUCT}`;
             document.getElementById('offer-price-input').value = '';
             hideModal('product-detail-modal');
             showModal('offer-price-modal');
        };

        document.getElementById('btn-cancel-offer').onclick = () => {
            hideModal('offer-price-modal');
            showProductDetail(currentReservationKey);
        };

        offerPriceForm.onsubmit = async (e) => {
            e.preventDefault();
            const priceInput = document.getElementById('offer-price-input').value;

            if (!priceInput.match(/^\d+$/)) {
                alert("Zadejte prosím pouze číslo.");
                return;
            }

            hideModal('offer-price-modal');
            showLoadingScreen("Odesílám nabídku...");

            try {
                await update(ref(db, `products/${currentReservationKey}`), {
                    User_Nabidka_Cena: parseInt(priceInput, 10),
                    User_Nabidka_Stav: 'PENDING'
                });
                hideLoadingScreen();
                showProductDetail(currentReservationKey); // Vrátí se na detail, tlačítko už bude zašedlé
                alert("Vaše nabídka byla odeslána. Sledujte pravidelně popis produktu - naleznete v něm výsledek vyhodnocení z eshopu.");
            } catch (err) {
                console.error(err);
                hideLoadingScreen();
                alert("Chyba při odesílání.");
            }
        };


        // === Logika Nákupu (Krok 1 - Množství) ===

        document.getElementById('btn-buy-now').onclick = () => {
            quantityForm.reset();
            quantityErrorMessage.classList.add('hidden');
            purchaseQuantityInput.value = '1';
            hideModal('product-detail-modal');
            showModal('reservation-modal');
        };

        document.getElementById('btn-cancel-quantity').onclick = () => {
            hideModal('reservation-modal');
            showProductDetail(currentReservationKey);
        };

        quantityForm.onsubmit = (e) => {
            e.preventDefault();
            const product = allProducts[currentReservationKey];
            const availableKusy = parseInt(product.Kusy || 0, 10);
            const inputVal = purchaseQuantityInput.value.trim();
            const qty = parseInt(inputVal, 10);

            quantityErrorMessage.classList.add('hidden'); 

            if (isNaN(qty) || qty <= 0 || !inputVal.match(/^\d+$/)) {
                quantityErrorMessage.textContent = "Napište pouze číslo (> 0)!";
                quantityErrorMessage.classList.remove('hidden');
                return;
            }

            if (qty > availableKusy) {
                quantityErrorMessage.textContent = `Skladem pouze ${availableKusy} ks.`;
                quantityErrorMessage.classList.remove('hidden');
                return;
            }
            
            // Krok 1 OK -> Uložit množství a jít na Krok 2
            pendingQuantity = qty;
            hideModal('reservation-modal');
            prepareCheckoutModal(product);
        };

        // === Logika Nákupu (Krok 2 - Platba a Sleva) ===

        function prepareCheckoutModal(product) {
            // Nastavení viditelnosti dobírky
            if (product.Nastaveni_Dobirka && parseInt(product.Nastaveni_Dobirka, 10) === 1) {
                optionCOD.classList.remove('hidden');
            } else {
                optionCOD.classList.add('hidden');
            }

            // Nastavení viditelnosti slevového kódu
            if (product.Nastaveni_SlevovyKod && parseInt(product.Nastaveni_SlevovyKod, 10) === 1) {
                discountSection.classList.remove('hidden');
            } else {
                discountSection.classList.add('hidden');
            }

            // Reset formuláře
            checkoutForm.reset();
            discountInputContainer.classList.add('hidden');
            noDiscountText.classList.remove('hidden');
            
            showModal('checkout-options-modal');
        }

        // Ovládání checkboxu slevového kódu
        hasDiscountCheckbox.onchange = (e) => {
            if (e.target.checked) {
                discountInputContainer.classList.remove('hidden');
                noDiscountText.classList.add('hidden');
            } else {
                discountInputContainer.classList.add('hidden');
                noDiscountText.classList.remove('hidden');
            }
        };

        document.getElementById('btn-back-to-quantity').onclick = () => {
            hideModal('checkout-options-modal');
            showModal('reservation-modal');
        };

        // Dokončení objednávky
        checkoutForm.onsubmit = async (e) => {
            e.preventDefault();
            
            const product = allProducts[currentReservationKey];
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            let discountCode = "Žádný slevový kód";
            
            if (hasDiscountCheckbox.checked) {
                const codeVal = document.getElementById('discount-code-input').value.trim();
                if (codeVal) discountCode = codeVal;
            }

            hideModal('checkout-options-modal');
            showLoadingScreen("Autorizuji a dokončuji objednávku...");

            const currentObjednano = parseInt(product.Objednano || 0, 10);
            
            const updates = {
                Kusy: parseInt(product.Kusy || 0) - pendingQuantity,
                Reservation: 1,
                Objednano: currentObjednano + pendingQuantity,
                Objednavka_Platba: paymentMethod,
                Objednavka_Sleva: discountCode
            };

            try {
                await update(ref(db, `products/${currentReservationKey}`), updates);
                
                const requiresEmail = parseInt(product.Email, 10) === 1;
                let redirectUrl = requiresEmail 
                    ? "https://nutny-mail-el-licence-objednavka-dokonceni-545664dc564f.mystrikingly.com/"
                    : "https://neni-nutny-mail-dokonceni-objednavky-54645456df4.mystrikingly.com/";
                
                window.location.href = redirectUrl;

            } catch (error) {
                console.error(error);
                hideLoadingScreen();
                showToast("Chyba při objednávce.", true);
            }
        };


        // === Inicializace ===

        document.getElementById('btn-close-detail').onclick = () => hideModal('product-detail-modal');
        document.getElementById('btn-select-nove').onclick = () => selectCategory('Nove');
        document.getElementById('btn-select-bazar').onclick = () => selectCategory('Bazar');

        let initialDataLoaded = false;
        onValue(productsRef, (snapshot) => {
            allProducts = snapshot.val() || {};
            if (!initialDataLoaded) {
                 loadingMessage.classList.add('hidden');
                 initialDataLoaded = true;
            }
            document.getElementById('product-list-container').classList.remove('hidden');
            if (currentFilter) renderProductList(allProducts, currentFilter);
        });

    </script>
</body>

</html>

